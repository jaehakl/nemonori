function p(n,t){if(n)for(const e of n)switch(e.type){case"resource.add":{const s=e.k,a=e.v||0;t.state.resources||(t.state.resources={}),t.state.resources[s]=(t.state.resources[s]||0)+a,l(t,`+${a} ${s}`);break}case"flag.set":{t.state.flags[e.key]=e.v;break}case"hp.damage":{l(t,`Damage ${e.amount} -> ${e.target}`);break}case"log":{l(t,e.msg,e.meta);break}default:console.warn("Unknown effect",e)}}function l(n,t,e){n.log.push({t:Date.now(),msg:t,meta:e})}function k(){const n=new Map;return{on(t,e){(n.get(t)||n.set(t,[]).get(t)).push(e)},off(t,e){const s=n.get(t);if(s){const a=s.indexOf(e);a>-1&&s.splice(a,1)}},emit(t,e){(n.get(t)||[]).forEach(s=>s(e))}}}function b(n){let t=1779033703^n.length;for(let e=0;e<n.length;e++)t=Math.imul(t^n.charCodeAt(e),3432918353),t=t<<13|t>>>19;return function(){return t=Math.imul(t^t>>>16,2246822507),t=Math.imul(t^t>>>13,3266489909),(t^=t>>>16)>>>0}}function M(n){return function(){let t=n+=1831565813;return t=Math.imul(t^t>>>15,t|1),t^=t+Math.imul(t^t>>>7,t|61),((t^t>>>14)>>>0)/4294967296}}function y(n,t){const e=b(String(n))(),s=M(e),a={float:()=>s(),int:o=>Math.floor(s()*o),roll:o=>s()<o},g=k(),i={flags:{},resources:{}},r={rand:a,bus:g,state:i,log:[]},f=t.map(o=>typeof o=="function"?o():o);for(const o of f)typeof o.init=="function"&&o.init(r);return{ctx:r,modules:f,dispatch(o,m,d){const c=f.find(h=>h.id===o);if(!c||!c.actions||!c.actions[m])return;const u=c.actions[m](d,r)||[];return p(u,r),g.emit("effects.applied",u),u},save(){return{v:1,seed:n,state:i}},load(o){o&&o.state&&Object.assign(i,o.state)}}}export{y as c};
